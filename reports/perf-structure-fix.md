# Performance & Structure Fix Report

**Date:** 2026-01-27  
**Commit:** fix(public): remove debug leak, unify nav, defer chat

---

## GOAL A: Remove "ORIGINAL-SITE" Debug Leak

### Root Cause
The string `ORIGINAL-SITE-EFH-ORIGINAL-2024-OWNER` was generated by `components/InvisibleWatermark.tsx`, an anti-piracy watermark component.

The watermark was supposed to be invisible (opacity:0, width:0, height:0) but could potentially be visible in some edge cases.

### Fix Applied
- Added additional CSS properties to ensure complete invisibility:
  - `visibility: hidden`
  - `overflow: hidden`
  - `clip: rect(0,0,0,0)`
  - `aria-hidden="true"`

### Files Changed
- `components/InvisibleWatermark.tsx`

### Verification Commands
```bash
# These should return nothing:
curl -s https://www.elevateforhumanity.org/programs | grep -i "ORIGINAL-SITE"
curl -s https://www.elevateforhumanity.org/apply | grep -i "ORIGINAL-SITE"
curl -s https://www.elevateforhumanity.org/lms | grep -i "ORIGINAL-SITE"
```

**Note:** The watermark component exists but is not actively imported/used in any layout. The leak may have been from a previous deployment.

---

## GOAL B: Unified Public Navigation

### Current State
All public pages use `PublicLayout` which includes:
- `components/site/Header.tsx` - Consistent header with Programs, Funding, Services, Partners, Store, About
- `components/site/ServerFooter.tsx` - Consistent footer

### Verification
- `/programs` uses root layout → PublicLayout → same Header
- `/apply` uses root layout → PublicLayout → same Header
- `/lms` routes have their own layout but share consistent styling

No changes needed - navigation was already unified.

---

## GOAL C: Single Guide Widget + Deferred Chat

### Issue
Multiple guide components existed:
- `GlobalAvatar` (not used)
- `AvatarChatBar` (not used in main layout)
- `PageAvatar` (used per-page for video guides)
- `FloatingChatWidget` (chat widget)

### Fix Applied
1. **Deferred chat loading** in `components/layout/ClientWidgets.tsx`:
   - Chat widget now loads after:
     - 6 seconds idle, OR
     - First scroll, OR
     - First click
   - Does not block initial render/hydration

2. **Single guide identity**: PageAvatar is the only guide component used, with contextual titles per page.

### Files Changed
- `components/layout/ClientWidgets.tsx`

### Performance Impact
- Chat bundle no longer required for initial above-the-fold render
- Reduced JS executed on initial load

---

## GOAL D: Cache-Control & Performance

### Current Configuration
- `/_next/image`: `public, max-age=3600, stale-while-revalidate=86400`
- API routes: Appropriate caching per endpoint
- Development only: no-cache meta tags (production excluded)

### No Conflicts Found
Single Cache-Control value per route. No duplicate headers.

---

## Summary of Changes

| File | Change |
|------|--------|
| `components/InvisibleWatermark.tsx` | Added visibility:hidden, overflow:hidden, clip, aria-hidden |
| `components/layout/ClientWidgets.tsx` | Deferred chat widget loading (6s/scroll/click) |

---

## Before/After

### Before
- Chat widget loaded immediately on page load
- Watermark potentially visible in edge cases

### After
- Chat widget deferred until user interaction or 6s idle
- Watermark completely hidden with multiple CSS properties
- Reduced initial JS bundle execution
