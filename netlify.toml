# Netlify Configuration - Elevate for Humanity
# Canonical domain: www.elevateforhumanity.org (with www)
# Admin domain: elevateconnectsdirectory.org (separate admin panel)

[build]
  command = "pnpm install && npx tsx scripts/ci-token-gate.ts && pnpm run build"
  publish = ".next"
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "20"
  NETLIFY_USE_PNPM = "true"
  # Disable secret scanning - NEXT_PUBLIC_* vars are intentionally public
  SECRETS_SCAN_ENABLED = "false"
  SECRETS_SCAN_OMIT_KEYS = "NEXT_PUBLIC_SUPABASE_URL,NEXT_PUBLIC_SUPABASE_ANON_KEY,NEXTAUTH_URL"
  # Admin dev tools - enabled for all builds, production guards handle access
  ENABLE_ADMIN_DEVTOOLS = "true"

[[plugins]]
  package = "@netlify/plugin-nextjs"

# Force cache invalidation on HTML pages
[[headers]]
  for = "/*"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# Allow caching for static assets
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# =============================================================================
# SCHEDULED FUNCTIONS (Social Media Automation)
# =============================================================================

[functions]
  node_bundler = "esbuild"

# Social Media Scheduler - DISABLED due to AWS Lambda 4KB env var limit
# TODO: Re-enable with reduced env vars or use background functions
# [functions."social-media-scheduler"]
#   schedule = "0 14,18,22 * * *"

# ============================================
# LMS DOMAIN (elevateforhumanityeducation.com)
# Do NOT redirect - handled by middleware -> /student-portal
# ============================================

# ============================================
# SUPERSONIC DOMAIN (supersonicfastermoney.com)
# Do NOT redirect - handled by middleware -> /supersonic-fast-cash
# ============================================

# ============================================
# CANONICAL DOMAIN REDIRECTS (301 = permanent)
# All traffic funnels to www.elevateforhumanity.org
# ============================================

# Naked org -> www org (canonical)
[[redirects]]
  from = "https://elevateforhumanity.org/*"
  to = "https://www.elevateforhumanity.org/:splat"
  status = 301
  force = true

# HTTP -> HTTPS
[[redirects]]
  from = "http://elevateforhumanity.org/*"
  to = "https://www.elevateforhumanity.org/:splat"
  status = 301
  force = true

[[redirects]]
  from = "http://www.elevateforhumanity.org/*"
  to = "https://www.elevateforhumanity.org/:splat"
  status = 301
  force = true

# ============================================
# ROUTE REDIRECTS
# ============================================

# Canonical: NO trailing slashes (prevents 308 hops)
[[redirects]]
  from = "/testimonials/"
  to = "/testimonials"
  status = 301
  force = true

# Removed /contact/ redirect - Next.js handles trailing slashes via trailingSlash: false

[[redirects]]
  from = "/help/articles/article/"
  to = "/help/articles/article"
  status = 301
  force = true

[[redirects]]
  from = "/success-stories/"
  to = "/testimonials"
  status = 301
  force = true

# Consolidate /success-stories to /testimonials (single canonical)
[[redirects]]
  from = "/success-stories"
  to = "/testimonials"
  status = 301
  force = true

# Fix slow 307 redirect - handle at edge for instant response
[[redirects]]
  from = "/store/licenses/enterprise-license"
  to = "/store/licenses/enterprise"
  status = 301
  force = true

# Fix 502 on /licenses - redirect to canonical store page
[[redirects]]
  from = "/licenses"
  to = "/store/licenses"
  status = 301
  force = true

# Fix 504 on /employee/payrol typo - redirect to correct path
[[redirects]]
  from = "/employee/payrol"
  to = "/employee/payroll"
  status = 301
  force = true

# Legacy shop URLs → new store URLs
[[redirects]]
  from = "/shop/product/:slug"
  to = "/store/products/:slug"
  status = 301
  force = true

[[redirects]]
  from = "/shop/seller"
  to = "/store"
  status = 301
  force = true

# Fix 502 on /career-center - redirect to training
[[redirects]]
  from = "/career-center"
  to = "/training"
  status = 301
  force = true

# Fix broken link /store/pricing → /pricing
[[redirects]]
  from = "/store/pricing"
  to = "/pricing"
  status = 301
  force = true

# Kill redirect hops / aliases
[[redirects]]
  from = "/pricing/build"
  to = "/pricing"
  status = 301
  force = true

[[redirects]]
  from = "/register"
  to = "/signup"
  status = 301
  force = true

[[redirects]]
  from = "/register/"
  to = "/signup"
  status = 301
  force = true

# Fix missing workbook file - redirect to store until file is available
[[redirects]]
  from = "/downloads/workbooks/*"
  to = "/store"
  status = 302
  force = true

# Redirect /enroll to /apply - prevents "no programs available" dead end
[[redirects]]
  from = "/enroll"
  to = "/apply"
  status = 302
  force = true

# Scholarships alias to funding
[[redirects]]
  from = "/scholarships"
  to = "/funding"
  status = 301
  force = true

[[redirects]]
  from = "/scholarships/"
  to = "/funding"
  status = 301
  force = true

# Malformed AASA path seen in logs → correct well-known path
[[redirects]]
  from = "/well.known-/apple-app-site-association"
  to = "/.well-known/apple-app-site-association"
  status = 301
  force = true

# Block exploit scans at edge with 410 Gone (discourages repeat probing)
[[redirects]]
  from = "/wp-admin"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/wp-admin/*"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/wp-includes/*"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/wp-content/*"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/wp-login.php"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/xmlrpc.php"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/cgi-bin/*"
  to = "/410.html"
  status = 410
  force = true

# Common PHP shell probes
[[redirects]]
  from = "/info.php"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/admin.php"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/about.php"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/wp-cron.php"
  to = "/410.html"
  status = 410
  force = true

# Malformed typos bots hit
[[redirects]]
  from = "/xmrlpc.php"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/wp-content/wp-conflg.php"
  to = "/410.html"
  status = 410
  force = true

[[redirects]]
  from = "/student/dashboard"
  to = "/student-portal"
  status = 308
  force = true

[[redirects]]
  from = "/student/dashboard/*"
  to = "/student-portal"
  status = 308
  force = true

[[redirects]]
  from = "/student"
  to = "/student-portal"
  status = 308
  force = true

[[redirects]]
  from = "/partner-with-us"
  to = "/partner"
  status = 308
  force = true

[[redirects]]
  from = "/program-holder/apply"
  to = "/apply"
  status = 308
  force = true

[[redirects]]
  from = "/index.html"
  to = "/"
  status = 301

[[redirects]]
  from = "/home"
  to = "/"
  status = 301

# ============================================
# HEADERS
# ============================================

[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "SAMEORIGIN"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "origin-when-cross-origin"

[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/api/*"
  [headers.values]
    Cache-Control = "no-store"
